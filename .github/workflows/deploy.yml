# @format

name: Deploy

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - development
          - staging
          - production

env:
  NODE_VERSION: "22"
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            infrastructure:
              - 'infrastructure/**'

  build-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: always() && (needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch')
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      image-uri: ${{ steps.image-info.outputs.image-uri }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - run: corepack enable

      - run: make install

      - run: make test-frontend

      - run: make build-frontend

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check infrastructure
        id: check-infra
        run: make check-infra
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Fetch ECR URI
        id: get-ecr-repo
        if: steps.check-infra.outputs.exists == 'true'
        run: make fetch-ecr-uri
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2
        if: steps.check-infra.outputs.exists == 'true'

      - name: Build and push Docker
        if: steps.check-infra.outputs.exists == 'true'
        run: make docker-build-push
        env:
          ECR_REPO_URI: ${{ steps.get-ecr-repo.outputs.repository-uri }}
          IMAGE_TAG: ${{ github.sha }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}

      - name: Set outputs
        id: image-info
        if: steps.check-infra.outputs.exists == 'true'
        run: |
          echo "image-tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "image-uri=${{ steps.get-ecr-repo.outputs.repository-uri }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Skip notice
        if: steps.check-infra.outputs.exists != 'true'
        run: |
          echo "::notice::Skipping frontend Docker build - infrastructure not deployed yet"

  approve-infrastructure-deployment:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend]
    if: |
      always() && 
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') && 
      needs.detect-changes.outputs.infrastructure == 'true'
    environment:
      name: approve-infrastructure-${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
    steps:
      - run: echo "::notice::Waiting for manual approval to deploy infrastructure..."

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend, approve-infrastructure-deployment]
    if: |
      always() && 
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') && 
      (needs.approve-infrastructure-deployment.result == 'success' || needs.detect-changes.outputs.infrastructure != 'true')
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
    concurrency:
      group: deploy-infra-${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - run: corepack enable

      - run: make install

      - run: make build-infrastructure

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Fetch AWS accounts
        run: make fetch-aws-accounts
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}

      - name: Verify CDK bootstrap
        run: make verify-cdk-bootstrap
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - run: make cdk-synth
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          AWS_REGION: ${{ env.AWS_REGION }}
          IMAGE_TAG: ${{ needs.build-frontend.outputs.image-tag || 'nginx:alpine' }}

      - run: make cdk-deploy
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          AWS_REGION: ${{ env.AWS_REGION }}
          IMAGE_TAG: ${{ needs.build-frontend.outputs.image-tag || 'nginx:alpine' }}
